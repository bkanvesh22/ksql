#!/bin/bash

# Define the ksqlDB REST API endpoint URL
KSQLDB_API="http://ksqldb-server:8088"

# Function to execute a specific ksqlDB query
execute_ksql_query() {
    QUERY="$1"

    # Execute the ksqlDB query using the REST API and capture the response
    RESPONSE=$(curl -X "POST" "$KSQLDB_API/ksql" \
        -H "Content-Type: application/vnd.ksql.v1+json" \
        --data-raw "{\"ksql\": \"$QUERY\"}")

    # Print the API response to the output
    echo "$RESPONSE"
}

# Check if a query file argument is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <query_file>"
    exit 1
fi

# Read the queries from the file
while IFS='' read -r query || [[ -n "$query" ]]; do
    if [[ -n "$query" ]]; then
        # If the line is not empty, append it to the current query
        current_query+="$query"$'\n'
    else
        # If an empty line is encountered, execute the current query (if not empty)
        if [[ -n "$current_query" ]]; then
            execute_ksql_query "$current_query"
        fi
        # Reset the current query for the next iteration
        current_query=""
    fi
done < "$1"

# Execute any remaining query if there's one without a trailing blank line
if [[ -n "$current_query" ]]; then
    execute_ksql_query "$current_query"
fi
